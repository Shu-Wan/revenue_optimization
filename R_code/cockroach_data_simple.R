library(lubridate)
library(dplyr)
library(rstan)
library(zoo)


tpois <- function(mu, lower, upper) {
  samp <- rpois(1, mu)
  while (samp < lower | samp > upper)
    samp <- rpois(1, mu)
  return(samp)
}

rtpois <- function(N, mu, lower, upper) {
  samps <- rep(NA_real_)
  for (n in 1:N)
    samps[n] <- tpois(mu, lower, upper)
  return(samps)
}

gen_data <- function(N_buildings, N_wks, obs_noise = 20, seed=123) {
  set.seed(seed)
  building_inds <- as.vector(sapply(1:N_buildings, rep, N_wks))
  building_data <- data.frame(building_id = 1:N_buildings,
                              floors = rtpois(N_buildings, 10, 3, 20),
                              sq_footage_p_floor = rnorm(N_buildings) * 7 * sqrt(3500) + 5000,
                              #sq_footage_p_floor = sample(c(465,672,1028),N_buildings,replace=T),
                              live_in_super = sample(c(0,1),N_buildings, replace=T),
                              monthly_average_rent = rnorm(N_buildings) * 7 * sqrt(3500) + 3500,
                              average_tenant_age = rnorm(N_buildings) * 7 + 50,
                              age_of_building = rtpois(N_buildings, 50, 20, 70)) %>% 
    mutate(
      total_sq_foot = sq_footage_p_floor * floors
    )
    
  wk_inds <- rep(1:N_wks, N_buildings)
  dates <- as_date('2017-01-01') + (1:N_wks)*30
  n_trap_changes <- rtpois(N_buildings,3,1,4)
  starting_traps <- rtpois(N_buildings,9,4,8)
  traps <- sapply(n_trap_changes,function(x) sort(sample(2:N_wks,x, replace=F)))
  building_traps <- c()
  phi_buildings <- 0.5
  sig_buildings <- 0.05
  for (n in 1:N_buildings) {
    changes <- traps[[n]]
    starting_trap <- starting_traps[n]
    level_changes <- 2*rbinom(length(changes), 1, 0.5) - 1
    levels <- cumsum(c(starting_trap, level_changes))
    df_levels <- data.frame(trap = levels, ind = c(1,changes))
    p_series <- rep(NA_real_,N_wks)
    p_series[df_levels$ind] <- df_levels$trap
    p_series <- zoo::na.locf(p_series)
    building_traps <- c(building_traps, p_series)
  }
  building_attr_beta <- scale(building_data[1:N_buildings,c('live_in_super','age_of_building')])
  building_attr_alpha <- scale(building_data[1:N_buildings,c('live_in_super','age_of_building','monthly_average_rent',
                                                             'average_tenant_age')])
  overall_mu <- log(0.5)
  sd_alpha <- 0.05
  overall_beta <- 0.75
  sd_beta <- 0.05
  gamma <- c(-0.15,0.15)
  alphas <- (overall_mu + sd_alpha * rnorm(N_buildings)) + log(building_data$total_sq_foot/1e4) + 
    building_attr_alpha %*% c(log(0.5),log(0.9),log(0.8),log(0.8))
  betas <- -exp(overall_beta + building_attr_beta %*% gamma + sd_beta * rnorm(N_buildings))/10
  wk_noise <- rnorm(N_wks) * 0.05
  mus <- alphas[building_inds] + betas[building_inds] * (building_traps - mean(building_traps)) + wk_noise[wk_inds]
  df_pred <- data.frame(mus = mus, building_id = building_inds, wk_ind = wk_inds, date = dates[wk_inds], trap = building_traps)
  df_pred <- df_pred %>% left_join(building_data, by = 'building_id') %>%
    mutate(month = lubridate::month(date))
  for (n in 1:nrow(df_pred))
    df_pred$complaints[n] <- rnbinom(n = 1, mu = exp(df_pred$mus[n]), size = obs_noise)

  df_ret <- df_pred %>% select(complaints, building_id, trap, date, 
                               live_in_super, age_of_building, total_sq_foot,
                               average_tenant_age, monthly_average_rent,
                               floors)
  return(list(df = df_ret,
              df_pred = df_pred,
              betas = betas,
              alphas = alphas)) 
}

#set.seed(12)
df_test <- gen_data(10, 12, obs_noise = 4, seed=12)
hist(df_test$df$complaints)
hist(df_test$betas)
#hist(df_test$alphas)
df_test_2 <- gen_data(100, 50, obs_noise = 12, seed=12)
df <- df_test_2$df
df %>% mutate(idx = as.integer(as.factor(title)), opt_price = -1/df_test_2$betas[idx]) -> df_mod
unique(df_mod[,c('title','opt_price')])
summary(df$units_sold)
with(dplyr::filter(df_test$df, building_id == 1), plot(date, complaints, type = 'l'))
saveRDS(rename(df_test$df,traps=trap), 'data/building_data_20180723.RDS')
